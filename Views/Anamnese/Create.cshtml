@model MeuSiteEmMVC.Models.Anamnese

@{
    ViewData["Title"] = "Anamnese";
}

@section Styles {
    <link rel="stylesheet" href="~/css/paciente.css" />
}

<div class="container py-4">
    <div class="card shadow-sm">
        <div class="card-header" style="background-color: #f8f9fa; border-bottom: 1px solid #e9ecef;">
            <h4 class="mb-0 text-dark">Anamnese</h4>
        </div>
        <div class="card-body">
            <form asp-action="Create" id="anamneseForm">
                <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                <input type="hidden" asp-for="Paciente" class="form-control" required />

                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label asp-for="Data" class="form-label fw-bold">Data da Consulta</label>
                            <input type="text" asp-for="Data" class="form-control" required />
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label asp-for="Queixa" class="form-label fw-bold">Queixa Principal</label>
                    <textarea asp-for="Queixa" class="form-control" rows="2" required></textarea>
                    <span asp-validation-for="Queixa" class="text-danger">Por favor, descreva a queixa principal</span>
                </div>

                <div class="mb-3">
                    <label asp-for="Sintomas" class="form-label fw-bold">Sintomas</label>
                    <textarea asp-for="Sintomas" class="form-control" rows="3"></textarea>
                    <span asp-validation-for="Sintomas" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="Historico" class="form-label fw-bold">Histórico Clínico</label>
                    <textarea asp-for="Historico" class="form-control" rows="3"></textarea>
                    <span asp-validation-for="Historico" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="Exames" class="form-label fw-bold">Exames Complementares</label>
                    <textarea asp-for="Exames" class="form-control" rows="2"></textarea>
                    <span asp-validation-for="Exames" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="Hipoteses" class="form-label fw-bold">Hipóteses Diagnósticas</label>
                    <textarea asp-for="Hipoteses" class="form-control" rows="2"></textarea>
                    <span asp-validation-for="Hipoteses" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="Evolucao" class="form-label fw-bold">Evolução</label>
                    <textarea asp-for="Evolucao" class="form-control" rows="3"></textarea>
                    <span asp-validation-for="Evolucao" class="text-danger"></span>
                </div>

                <div class="mb-4">
                    <label asp-for="PlanoTeurapeutico" class="form-label fw-bold">Plano Terapêutico</label>
                    <textarea asp-for="PlanoTeurapeutico" class="form-control" rows="3"></textarea>
                    <span asp-validation-for="PlanoTeurapeutico" class="text-danger"></span>
                </div>

                <div class="d-flex justify-content-between">
                    <button type="submit" class="btn btn-salvar">
                        <i class="fas fa-save me-1"></i> Salvar Anamnese
                    </button>
                    <a asp-controller="Pacientes" asp-action="Index1" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i> Voltar
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

@* @section Styles {
    <style>
        .form-label.required:after {
            content: "";
        }
        
        .card {
            border: none;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .card-header {
            padding: 1.25rem 1.5rem;
            background-color: #f8f9fa;
        }
        
        .form-control, .form-select {
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            border: 1px solid #e0e0e0;
            transition: border-color 0.2s;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.1);
        }
        
        .btn {
            border-radius: 0.375rem;
            padding: 0.5rem 1.25rem;
            font-weight: 500;
        }
        
        .btn-outline-secondary {
            border-color: #6c757d;
            color: #6c757d;
        }
        
        .btn-outline-secondary:hover {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-primary {
            background-color: #0d6efd;
            border: none;
        }
        
        .btn-primary:hover {
            background-color: #0b5ed7;
        }
        
        /* Estilos para mensagens de erro */
        .field-validation-error {
            display: block;
            margin-top: 0.25rem;
            font-size: 0.875rem;
            color: #dc3545;
            font-weight: normal;
        }
        
        .is-invalid {
            border-color: #dc3545 !important;
            padding-right: calc(1.5em + 0.75rem);
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right calc(0.375em + 0.1875rem) center;
            background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
        }
        
        .is-invalid:focus {
            border-color: #dc3545;
            box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.1);
        }
    </style>
} *@

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        // Atualiza o nome do paciente no título quando o campo for preenchido
        document.addEventListener('input', function(e) {
            if (e.target.id === 'Paciente') {
                const nomePaciente = e.target.value.trim() || 'Novo Paciente';
                document.getElementById('nomePaciente').textContent = nomePaciente;
                document.title = `Anamnese - ${nomePaciente}`;
            }
        });

        // Esconde todas as mensagens de erro inicialmente
        document.querySelectorAll('.text-danger').forEach(span => {
            span.style.display = 'none';
        });

        // Remove a classe is-invalid de todos os campos ao carregar
        document.querySelectorAll('.form-control, .form-select, .form-textarea').forEach(field => {
            field.classList.remove('is-invalid');
        });

        // Variável para controlar se já houve tentativa de envio
        let formSubmitted = false;

        // Validação no envio do formulário
        document.getElementById('anamneseForm').addEventListener('submit', function(e) {
            formSubmitted = true;
            let isValid = true;
            const requiredFields = document.querySelectorAll('input[required], textarea[required], select[required]');
            
            requiredFields.forEach(field => {
                if (!validateField(field, true)) {
                    isValid = false;
                }
            });
            
            if (!isValid) {
                e.preventDefault();
            }
        });
        
        // Validação em tempo real (só após a primeira tentativa de envio)
        document.querySelectorAll('input[required], textarea[required], select[required]').forEach(field => {
            // Valida quando o campo perde o foco (só após a primeira tentativa de envio)
            field.addEventListener('blur', function() {
                if (formSubmitted) {
                    validateField(this, true);
                }
            });
            
            // Valida ao digitar (com debounce para melhor performance)
            let timeout;
            field.addEventListener('input', function() {
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    if (formSubmitted) {
                        validateField(this, false);
                    } else {
                        // Se ainda não submeteu, só remove a mensagem de erro se o campo estiver válido
                        if (this.value.trim() !== '') {
                            this.classList.remove('is-invalid');
                            const errorSpan = this.nextElementSibling;
                            if (errorSpan && errorSpan.classList.contains('text-danger')) {
                                errorSpan.style.display = 'none';
                            }
                        }
                    }
                }, 300);
            });
        });
        
        function validateField(field, showError) {
            const errorSpan = field.nextElementSibling;
            if (!errorSpan || !errorSpan.classList.contains('text-danger')) return true;
            
            const isEmpty = field.value.trim() === '' || (field.type === 'select-one' && field.value === '');
            
            if (isEmpty) {
                if (showError) {
                    field.classList.add('is-invalid');
                    errorSpan.style.display = 'block';
                }
                return false;
            } else {
                field.classList.remove('is-invalid');
                errorSpan.style.display = 'none';
                return true;
            }
        }
            
            // Configura a data atual como padrão
            const dataInput = document.getElementById('Data');
            if (dataInput && !dataInput.value) {
                const now = new Date();
                const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
                dataInput.value = localDateTime;
            }
        });
    </script>
}
